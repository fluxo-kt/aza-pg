name: "Setup Bun"
description: "Parse Bun version from .tool-versions, install Bun, cache dependencies, and install packages"
author: "fluxo-kt"

# No inputs required - auto-detects from .tool-versions and bun.lock

outputs:
  bun-version:
    description: "The Bun version that was installed"
    value: ${{ steps.bun-version.outputs.version }}
  cache-hit:
    description: "Whether there was a cache hit"
    value: ${{ steps.cache-deps.outputs.cache-hit }}

runs:
  using: "composite"
  steps:
    - name: Parse Bun version from .tool-versions
      id: bun-version
      shell: bash
      run: |
        set -euo pipefail
        # Parse .tool-versions directly (bun not installed yet, can't use parse-bun-version.ts)
        BUN_VERSION=$(grep '^bun ' .tool-versions | awk '{print $2}')
        if [[ -z "${BUN_VERSION}" ]]; then
          echo "âŒ ERROR: Could not parse bun version from .tool-versions"
          exit 1
        fi
        echo "version=${BUN_VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Detected Bun version: ${BUN_VERSION}"

    - name: Set up Bun and dependencies
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ steps.bun-version.outputs.version }}

    - name: Cache Bun dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install dependencies
      shell: bash
      run: bun install --frozen-lockfile
      env:
        # 1-day supply chain security delay (verify packages aren't brand new)
        BUN_CONFIG_INSTALL_MINIMUM_RELEASE_AGE: "86400"
