# pgBackRest Backup Example
# Provides continuous WAL archiving + full/incremental/differential backups for PITR
#
# Usage:
#   1. Copy this file to your primary stack directory
#   2. Add pgbackrest service to your compose setup
#   3. Configure archive_command in postgresql.conf (see README.md)
#   4. Initialize stanza: docker compose exec pgbackrest pgbackrest stanza-create
#   5. Run backup: docker compose exec pgbackrest pgbackrest backup --type=full
#
# Recovery:
#   docker compose exec pgbackrest pgbackrest restore --target-timeline=latest

services:
  pgbackrest:
    image: pgbackrest/pgbackrest:2.53.1
    container_name: pgbackrest
    restart: unless-stopped

    environment:
      PGBACKREST_REPO1_PATH: /backup/repo
      PGBACKREST_REPO1_RETENTION_FULL: '7'  # Keep 7 full backups
      PGBACKREST_REPO1_RETENTION_DIFF: '4'  # Keep 4 differential backups
      PGBACKREST_LOG_LEVEL_CONSOLE: info
      PGBACKREST_LOG_LEVEL_FILE: debug

    volumes:
      # Backup repository (persistent storage)
      - pgbackrest_repo:/backup/repo

      # PostgreSQL data directory (for restore operations)
      - postgres_data:/var/lib/postgresql/data

      # WAL archive directory (shared with postgres container)
      - wal_archive:/wal_archive

      # Configuration
      - ./pgbackrest.conf:/etc/pgbackrest/pgbackrest.conf:ro

    networks:
      - postgres_net

    # Keep container running for archive_command and scheduled backups
    command: tail -f /dev/null

    deploy:
      resources:
        limits:
          memory: 512m
        reservations:
          memory: 256m

volumes:
  pgbackrest_repo:
    name: pgbackrest-repo
  wal_archive:
    name: wal-archive
  postgres_data:
    external: true
    name: ${POSTGRES_DATA_VOLUME:-postgres-primary-data}

networks:
  postgres_net:
    external: true
    name: ${POSTGRES_NETWORK_NAME:-postgres-primary-net}
