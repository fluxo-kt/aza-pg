# PostgreSQL Exporter Custom Queries

pg_replication_lag:
  query: |
    SELECT CASE
      WHEN pg_is_in_recovery()
      THEN COALESCE(EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())), 0)
      ELSE 0
    END as lag_seconds
  metrics:
    - lag_seconds:
        usage: 'GAUGE'
        description: 'Replication lag in seconds (0 on primary or if no replay yet)'

pg_postmaster_uptime:
  query: 'SELECT EXTRACT(EPOCH FROM (now() - pg_postmaster_start_time()))::bigint as uptime_seconds'
  metrics:
    - uptime_seconds:
        usage: 'COUNTER'
        description: 'PostgreSQL uptime in seconds since postmaster start'

pg_memory_settings:
  query: |
    SELECT
      name,
      CASE
        WHEN unit = '8kB' THEN (setting::bigint * 8 * 1024)
        WHEN unit = 'kB' THEN (setting::bigint * 1024)
        WHEN unit = 'MB' THEN (setting::bigint * 1024 * 1024)
        WHEN unit = 'GB' THEN (setting::bigint * 1024 * 1024 * 1024)
        ELSE setting::bigint
      END as value_bytes,
      source as config_source
    FROM pg_settings
    WHERE name IN ('shared_buffers', 'effective_cache_size', 'maintenance_work_mem', 'work_mem')
  metrics:
    - name:
        usage: 'LABEL'
        description: 'PostgreSQL setting name'
    - config_source:
        usage: 'LABEL'
        description: 'Configuration source (configuration file, command line, etc.)'
    - value_bytes:
        usage: 'GAUGE'
        description: 'Memory setting value in bytes'

pg_wal_directory_size:
  query: 'SELECT COALESCE((SELECT SUM(size) FROM pg_ls_waldir()), 0) as wal_size_bytes'
  metrics:
    - wal_size_bytes:
        usage: 'GAUGE'
        description: 'Total size of WAL directory in bytes'

pg_temp_files:
  query: 'SELECT COALESCE(SUM(temp_bytes), 0) as temp_bytes_total FROM pg_stat_database'
  metrics:
    - temp_bytes_total:
        usage: 'COUNTER'
        description: 'Total bytes written to temp files'

pg_connection_usage:
  query: |
    SELECT
      (SELECT setting::int FROM pg_settings WHERE name = 'max_connections') as max_conn,
      (SELECT COUNT(*) FROM pg_stat_activity) as current_conn,
      (SELECT setting::int FROM pg_settings WHERE name = 'superuser_reserved_connections') as reserved_conn
  metrics:
    - max_conn:
        usage: 'GAUGE'
        description: 'Maximum allowed connections'
    - current_conn:
        usage: 'GAUGE'
        description: 'Current active connections'
    - reserved_conn:
        usage: 'GAUGE'
        description: 'Reserved connections for superuser'
